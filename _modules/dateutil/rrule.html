

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dateutil.rrule &mdash; Matplotlib API 1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Matplotlib API 1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Matplotlib API
          

          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.html">1. matplotlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.pyplot.html">2. matplotlib.pyplot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.axes.html">3. matplotlib.axes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.axis.html">4. matplotlib.axis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.cm.html">5. matplotlib.cm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.colorbar.html">6. matplotlib.colorbar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.colors.html">7. matplotlib.colors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.figure.html">8. matplotlib.figure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.legend.html">9. matplotlib.legend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.lines.html">10. matplotlib.lines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.markers.html">11. matplotlib.markers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.patches.html">12. matplotlib.patches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.style.html">13. matplotlib.style</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.text.html">14. matplotlib.text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.widgets.html">15. matplotlib.widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../separator.html">16. ===== INFREQ =====</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.animation.html">17. matplotlib.animation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.artist.html">18. matplotlib.artist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.backends.html">19. matplotlib.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.cbook.html">20. matplotlib.cbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.collections.html">21. matplotlib.collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.dates.html">22. matplotlib.dates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.dviread.html">23. matplotlib.dviread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.finance.html">24. matplotlib.finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.font_manager.html">25. matplotlib.font_manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.gridspec.html">26. matplotlib.gridspec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.image.html">27. matplotlib.image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.mathtext.html">28. matplotlib.mathtext</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.mlab.html">29. matplotlib.mlab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.offsetbox.html">30. matplotlib.offsetbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.path.html">31. matplotlib.path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.patheffects.html">32. matplotlib.patheffects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.sankey.html">33. matplotlib.sankey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.spines.html">34. matplotlib.spines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.ticker.html">35. matplotlib.ticker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.tight_layout.html">36. matplotlib.tight_layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.tri.html">37. matplotlib.tri</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.type1font.html">38. matplotlib.type1font</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/matplotlib.units.html">39. matplotlib.units</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Matplotlib API</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>dateutil.rrule</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dateutil.rrule</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The rrule module offers a small, complete, and very fast, implementation of</span>
<span class="sd">the recurrence rules documented in the</span>
<span class="sd">`iCalendar RFC &lt;http://www.ietf.org/rfc/rfc2445.txt&gt;`_,</span>
<span class="sd">including support for caching of results.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">gcd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">fractions</span> <span class="k">import</span> <span class="n">gcd</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">advance_iterator</span><span class="p">,</span> <span class="n">integer_types</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">_thread</span>
<span class="kn">import</span> <span class="nn">heapq</span>

<span class="c1"># For warning about deprecation of until and count</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rrule&quot;</span><span class="p">,</span> <span class="s2">&quot;rruleset&quot;</span><span class="p">,</span> <span class="s2">&quot;rrulestr&quot;</span><span class="p">,</span>
           <span class="s2">&quot;YEARLY&quot;</span><span class="p">,</span> <span class="s2">&quot;MONTHLY&quot;</span><span class="p">,</span> <span class="s2">&quot;WEEKLY&quot;</span><span class="p">,</span> <span class="s2">&quot;DAILY&quot;</span><span class="p">,</span>
           <span class="s2">&quot;HOURLY&quot;</span><span class="p">,</span> <span class="s2">&quot;MINUTELY&quot;</span><span class="p">,</span> <span class="s2">&quot;SECONDLY&quot;</span><span class="p">,</span>
           <span class="s2">&quot;MO&quot;</span><span class="p">,</span> <span class="s2">&quot;TU&quot;</span><span class="p">,</span> <span class="s2">&quot;WE&quot;</span><span class="p">,</span> <span class="s2">&quot;TH&quot;</span><span class="p">,</span> <span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="s2">&quot;SA&quot;</span><span class="p">,</span> <span class="s2">&quot;SU&quot;</span><span class="p">]</span>

<span class="c1"># Every mask is 7 days longer to handle cross-year weekly periods.</span>
<span class="n">M366MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">29</span><span class="o">+</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span>
                 <span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
<span class="n">M365MASK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">M366MASK</span><span class="p">)</span>
<span class="n">M29</span><span class="p">,</span> <span class="n">M30</span><span class="p">,</span> <span class="n">M31</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
<span class="n">MDAY366MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">M31</span><span class="o">+</span><span class="n">M29</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">MDAY365MASK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MDAY366MASK</span><span class="p">)</span>
<span class="n">M29</span><span class="p">,</span> <span class="n">M30</span><span class="p">,</span> <span class="n">M31</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">NMDAY366MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">M31</span><span class="o">+</span><span class="n">M29</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">NMDAY365MASK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">NMDAY366MASK</span><span class="p">)</span>
<span class="n">M366RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
<span class="n">M365RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">334</span><span class="p">,</span> <span class="mi">365</span><span class="p">)</span>
<span class="n">WDAYMASK</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">55</span>
<span class="k">del</span> <span class="n">M29</span><span class="p">,</span> <span class="n">M30</span><span class="p">,</span> <span class="n">M31</span><span class="p">,</span> <span class="n">M365MASK</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span> <span class="n">MDAY365MASK</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span> <span class="n">NMDAY365MASK</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span>
<span class="n">MDAY365MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MDAY365MASK</span><span class="p">)</span>
<span class="n">M365MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">M365MASK</span><span class="p">)</span>

<span class="n">FREQNAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;YEARLY&#39;</span><span class="p">,</span><span class="s1">&#39;MONTHLY&#39;</span><span class="p">,</span><span class="s1">&#39;WEEKLY&#39;</span><span class="p">,</span><span class="s1">&#39;DAILY&#39;</span><span class="p">,</span><span class="s1">&#39;HOURLY&#39;</span><span class="p">,</span><span class="s1">&#39;MINUTELY&#39;</span><span class="p">,</span><span class="s1">&#39;SECONDLY&#39;</span><span class="p">]</span>

<span class="p">(</span><span class="n">YEARLY</span><span class="p">,</span>
 <span class="n">MONTHLY</span><span class="p">,</span>
 <span class="n">WEEKLY</span><span class="p">,</span>
 <span class="n">DAILY</span><span class="p">,</span>
 <span class="n">HOURLY</span><span class="p">,</span>
 <span class="n">MINUTELY</span><span class="p">,</span>
 <span class="n">SECONDLY</span><span class="p">)</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># Imported on demand.</span>
<span class="n">easter</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">parser</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">weekday</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;weekday&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weekday</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create weekday with n == 0&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span> <span class="o">=</span> <span class="n">weekday</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weekday</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">weekday</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;MO&quot;</span><span class="p">,</span> <span class="s2">&quot;TU&quot;</span><span class="p">,</span> <span class="s2">&quot;WE&quot;</span><span class="p">,</span> <span class="s2">&quot;TH&quot;</span><span class="p">,</span> <span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="s2">&quot;SA&quot;</span><span class="p">,</span> <span class="s2">&quot;SU&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">weekday</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%+d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

<span class="n">MO</span><span class="p">,</span> <span class="n">TU</span><span class="p">,</span> <span class="n">WE</span><span class="p">,</span> <span class="n">TH</span><span class="p">,</span> <span class="n">FR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SU</span> <span class="o">=</span> <span class="n">weekdays</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">weekday</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)])</span>


<span class="k">def</span> <span class="nf">_invalidates_cache</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for rruleset methods which may invalidate the</span>
<span class="sd">    cached length.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">inner_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">inner_func</span>


<span class="k">class</span> <span class="nc">rrulebase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">allocate_lock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_cache</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_cached</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_iter_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_gen</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="n">acquire</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">acquire</span>
        <span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">release</span>
        <span class="k">while</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
                <span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                        <span class="n">cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">advance_iterator</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_gen</span> <span class="o">=</span> <span class="n">gen</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">release</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">))[</span><span class="n">item</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">item</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">))[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># __len__() introduces a large performance penality.</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the number of recurrences in this set. It will have go</span>
<span class="sd">            trough the whole recurrence, if this hasn&#39;t been done before. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the last recurrence before the given datetime instance. The</span>
<span class="sd">            inc keyword defines what happens if dt is an occurrence. With</span>
<span class="sd">            inc=True, if dt itself is an occurrence, it will be returned. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">last</span>

    <span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the first recurrence after the given datetime instance. The</span>
<span class="sd">            inc keyword defines what happens if dt is an occurrence. With</span>
<span class="sd">            inc=True, if dt itself is an occurrence, it will be returned.  &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">xafter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator which yields up to `count` recurrences after the given</span>
<span class="sd">        datetime instance, equivalent to `after`.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            The datetime at which to start generating recurrences.</span>

<span class="sd">        :param count:</span>
<span class="sd">            The maximum number of recurrences to generate. If `None` (default),</span>
<span class="sd">            dates are generated until the recurrence rule is exhausted.</span>

<span class="sd">        :param inc:</span>
<span class="sd">            If `dt` is an instance of the rule and `inc` is `True`, it is</span>
<span class="sd">            included in the output.</span>

<span class="sd">        :yields: Yields a sequence of `datetime` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Select the comparison function</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dtc</span><span class="p">:</span> <span class="n">dc</span> <span class="o">&gt;=</span> <span class="n">dtc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dtc</span><span class="p">:</span> <span class="n">dc</span> <span class="o">&gt;</span> <span class="n">dtc</span>

        <span class="c1"># Generate dates</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">d</span>

                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                        <span class="k">break</span>

    <span class="k">def</span> <span class="nf">between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all the occurrences of the rrule between after and before.</span>
<span class="sd">        The inc keyword defines what happens if after and/or before are</span>
<span class="sd">        themselves occurrences. With inc=True, they will be included in the</span>
<span class="sd">        list, if they are found in the recurrence set. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">before</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">after</span><span class="p">:</span>
                        <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">before</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">after</span><span class="p">:</span>
                        <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span>


<div class="viewcode-block" id="rrule"><a class="viewcode-back" href="../../generated/generated/matplotlib.dates.rrule.html#matplotlib.dates.rrule">[docs]</a><span class="k">class</span> <span class="nc">rrule</span><span class="p">(</span><span class="n">rrulebase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    That&#39;s the base of the rrule operation. It accepts all the keywords</span>
<span class="sd">    defined in the RFC as its constructor parameters (except byday,</span>
<span class="sd">    which was renamed to byweekday) and more. The constructor prototype is::</span>

<span class="sd">            rrule(freq)</span>

<span class="sd">    Where freq must be one of YEARLY, MONTHLY, WEEKLY, DAILY, HOURLY, MINUTELY,</span>
<span class="sd">    or SECONDLY.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Per RFC section 3.3.10, recurrence instances falling on invalid dates</span>
<span class="sd">        and times are ignored rather than coerced:</span>

<span class="sd">            Recurrence rules may generate recurrence instances with an invalid</span>
<span class="sd">            date (e.g., February 30) or nonexistent local time (e.g., 1:30 AM</span>
<span class="sd">            on a day where the local time is moved forward by an hour at 1:00</span>
<span class="sd">            AM).  Such recurrence instances MUST be ignored and MUST NOT be</span>
<span class="sd">            counted as part of the recurrence set.</span>

<span class="sd">        This can lead to possibly surprising behavior when, for example, the</span>
<span class="sd">        start date occurs at the end of the month:</span>

<span class="sd">        &gt;&gt;&gt; from dateutil.rrule import rrule, MONTHLY</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime</span>
<span class="sd">        &gt;&gt;&gt; start_date = datetime(2014, 12, 31)</span>
<span class="sd">        &gt;&gt;&gt; list(rrule(freq=MONTHLY, count=4, dtstart=start_date))</span>
<span class="sd">        ... # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        [datetime.datetime(2014, 12, 31, 0, 0),</span>
<span class="sd">         datetime.datetime(2015, 1, 31, 0, 0),</span>
<span class="sd">         datetime.datetime(2015, 3, 31, 0, 0),</span>
<span class="sd">         datetime.datetime(2015, 5, 31, 0, 0)]</span>

<span class="sd">    Additionally, it supports the following keyword arguments:</span>

<span class="sd">    :param cache:</span>
<span class="sd">        If given, it must be a boolean value specifying to enable or disable</span>
<span class="sd">        caching of results. If you will use the same rrule instance multiple</span>
<span class="sd">        times, enabling caching will improve the performance considerably.</span>
<span class="sd">    :param dtstart:</span>
<span class="sd">        The recurrence start. Besides being the base for the recurrence,</span>
<span class="sd">        missing parameters in the final recurrence instances will also be</span>
<span class="sd">        extracted from this date. If not given, datetime.now() will be used</span>
<span class="sd">        instead.</span>
<span class="sd">    :param interval:</span>
<span class="sd">        The interval between each freq iteration. For example, when using</span>
<span class="sd">        YEARLY, an interval of 2 means once every two years, but with HOURLY,</span>
<span class="sd">        it means once every two hours. The default interval is 1.</span>
<span class="sd">    :param wkst:</span>
<span class="sd">        The week start day. Must be one of the MO, TU, WE constants, or an</span>
<span class="sd">        integer, specifying the first day of the week. This will affect</span>
<span class="sd">        recurrences based on weekly periods. The default week start is got</span>
<span class="sd">        from calendar.firstweekday(), and may be modified by</span>
<span class="sd">        calendar.setfirstweekday().</span>
<span class="sd">    :param count:</span>
<span class="sd">        How many occurrences will be generated.</span>

<span class="sd">        .. note::</span>
<span class="sd">            As of version 2.5.0, the use of the ``until`` keyword together</span>
<span class="sd">            with the ``count`` keyword is deprecated per RFC-2445 Sec. 4.3.10.</span>
<span class="sd">    :param until:</span>
<span class="sd">        If given, this must be a datetime instance, that will specify the</span>
<span class="sd">        limit of the recurrence. The last recurrence in the rule is the greatest</span>
<span class="sd">        datetime that is less than or equal to the value specified in the</span>
<span class="sd">        ``until`` parameter.</span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>
<span class="sd">            As of version 2.5.0, the use of the ``until`` keyword together</span>
<span class="sd">            with the ``count`` keyword is deprecated per RFC-2445 Sec. 4.3.10.</span>
<span class="sd">    :param bysetpos:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        positive or negative. Each given integer will specify an occurrence</span>
<span class="sd">        number, corresponding to the nth occurrence of the rule inside the</span>
<span class="sd">        frequency period. For example, a bysetpos of -1 if combined with a</span>
<span class="sd">        MONTHLY frequency, and a byweekday of (MO, TU, WE, TH, FR), will</span>
<span class="sd">        result in the last work day of every month.</span>
<span class="sd">    :param bymonth:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the months to apply the recurrence to.</span>
<span class="sd">    :param bymonthday:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the month days to apply the recurrence to.</span>
<span class="sd">    :param byyearday:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the year days to apply the recurrence to.</span>
<span class="sd">    :param byweekno:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the week numbers to apply the recurrence to. Week numbers</span>
<span class="sd">        have the meaning described in ISO8601, that is, the first week of</span>
<span class="sd">        the year is that containing at least four days of the new year.</span>
<span class="sd">    :param byweekday:</span>
<span class="sd">        If given, it must be either an integer (0 == MO), a sequence of</span>
<span class="sd">        integers, one of the weekday constants (MO, TU, etc), or a sequence</span>
<span class="sd">        of these constants. When given, these variables will define the</span>
<span class="sd">        weekdays where the recurrence will be applied. It&#39;s also possible to</span>
<span class="sd">        use an argument n for the weekday instances, which will mean the nth</span>
<span class="sd">        occurrence of this weekday in the period. For example, with MONTHLY,</span>
<span class="sd">        or with YEARLY and BYMONTH, using FR(+1) in byweekday will specify the</span>
<span class="sd">        first friday of the month where the recurrence happens. Notice that in</span>
<span class="sd">        the RFC documentation, this is specified as BYDAY, but was renamed to</span>
<span class="sd">        avoid the ambiguity of that keyword.</span>
<span class="sd">    :param byhour:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the hours to apply the recurrence to.</span>
<span class="sd">    :param byminute:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the minutes to apply the recurrence to.</span>
<span class="sd">    :param bysecond:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the seconds to apply the recurrence to.</span>
<span class="sd">    :param byeaster:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        positive or negative. Each integer will define an offset from the</span>
<span class="sd">        Easter Sunday. Passing the offset 0 to byeaster will yield the Easter</span>
<span class="sd">        Sunday itself. This is an extension to the RFC specification.</span>
<span class="sd">     &quot;&quot;&quot;</span>
<div class="viewcode-block" id="rrule.__init__"><a class="viewcode-back" href="../../generated/generated/matplotlib.dates.rrule.__init__.html#matplotlib.dates.rrule.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dtstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wkst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bysetpos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bymonth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bymonthday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byyearday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byeaster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">byweekno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byweekday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">byhour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byminute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bysecond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">rrule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">easter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dtstart</span><span class="p">:</span>
            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtstart</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">dtstart</span><span class="o">.</span><span class="n">toordinal</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span> <span class="o">=</span> <span class="n">dtstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tzinfo</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">tzinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c1"># Cache the original byxxx rules, if they are provided, as the _byxxx</span>
        <span class="c1"># attributes do not necessarily map to the inputs, and this can be</span>
        <span class="c1"># a problem in generating the strings. Only store things if they&#39;ve</span>
        <span class="c1"># been supplied (the string retrieval will just use .get())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">until</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">until</span><span class="o">.</span><span class="n">toordinal</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_until</span> <span class="o">=</span> <span class="n">until</span>

        <span class="k">if</span> <span class="n">count</span> <span class="ow">and</span> <span class="n">until</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Using both &#39;count&#39; and &#39;until&#39; is inconsistent with RFC 2445&quot;</span>
                 <span class="s2">&quot; and has been deprecated in dateutil. Future versions will &quot;</span>
                 <span class="s2">&quot;raise an error.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wkst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">firstweekday</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wkst</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span> <span class="o">=</span> <span class="n">wkst</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span> <span class="o">=</span> <span class="n">wkst</span><span class="o">.</span><span class="n">weekday</span>

        <span class="k">if</span> <span class="n">bysetpos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bysetpos</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bysetpos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">366</span> <span class="o">&lt;=</span> <span class="n">bysetpos</span> <span class="o">&lt;=</span> <span class="mi">366</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bysetpos must be between 1 and 366, &quot;</span>
                                 <span class="s2">&quot;or between -366 and -1&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">bysetpos</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bysetpos</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">366</span> <span class="o">&lt;=</span> <span class="n">pos</span> <span class="o">&lt;=</span> <span class="mi">366</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bysetpos must be between 1 and 366, &quot;</span>
                                     <span class="s2">&quot;or between -366 and -1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bysetpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byweekno</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byyearday</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bymonthday</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">byweekday</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byeaster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">YEARLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bymonth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bymonth</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">month</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bymonth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">bymonthday</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">day</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bymonthday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MONTHLY</span><span class="p">:</span>
                <span class="n">bymonthday</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">day</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bymonthday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">WEEKLY</span><span class="p">:</span>
                <span class="n">byweekday</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byweekday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># bymonth</span>
        <span class="k">if</span> <span class="n">bymonth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bymonth</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">bymonth</span> <span class="o">=</span> <span class="p">(</span><span class="n">bymonth</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bymonth</span><span class="p">)))</span>

            <span class="k">if</span> <span class="s1">&#39;bymonth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bymonth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span>

        <span class="c1"># byyearday</span>
        <span class="k">if</span> <span class="n">byyearday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byyearday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byyearday</span> <span class="o">=</span> <span class="p">(</span><span class="n">byyearday</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">byyearday</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byyearday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span>

        <span class="c1"># byeaster</span>
        <span class="k">if</span> <span class="n">byeaster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">easter</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">easter</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byeaster</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span> <span class="o">=</span> <span class="p">(</span><span class="n">byeaster</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">byeaster</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byeaster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># bymonthday</span>
        <span class="k">if</span> <span class="n">bymonthday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bymonthday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">bymonthday</span> <span class="o">=</span> <span class="p">(</span><span class="n">bymonthday</span><span class="p">,)</span>

            <span class="n">bymonthday</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bymonthday</span><span class="p">)</span>            <span class="c1"># Ensure it&#39;s unique</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bymonthday</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bymonthday</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Storing positive numbers first, then negative numbers</span>
            <span class="k">if</span> <span class="s1">&#39;bymonthday&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bymonthday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span><span class="p">))</span>

        <span class="c1"># byweekno</span>
        <span class="k">if</span> <span class="n">byweekno</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byweekno</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byweekno</span> <span class="o">=</span> <span class="p">(</span><span class="n">byweekno</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">byweekno</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byweekno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span>

        <span class="c1"># byweekday / bynweekday</span>
        <span class="k">if</span> <span class="n">byweekday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it&#39;s one of the valid non-sequence types, convert to a</span>
            <span class="c1"># single-element sequence before the iterator that builds the</span>
            <span class="c1"># byweekday set.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byweekday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">byweekday</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">):</span>
                <span class="n">byweekday</span> <span class="o">=</span> <span class="p">(</span><span class="n">byweekday</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">wday</span> <span class="ow">in</span> <span class="n">byweekday</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wday</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">wday</span><span class="o">.</span><span class="n">n</span> <span class="ow">or</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">MONTHLY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wday</span><span class="o">.</span><span class="n">weekday</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">wday</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span> <span class="n">wday</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="p">))</span>
                <span class="n">orig_byweekday</span> <span class="o">=</span> <span class="p">[</span><span class="n">weekday</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_byweekday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">))</span>
                <span class="n">orig_bynweekday</span> <span class="o">=</span> <span class="p">[</span><span class="n">weekday</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_bynweekday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;byweekday&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byweekday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                    <span class="n">orig_byweekday</span><span class="p">,</span> <span class="n">orig_bynweekday</span><span class="p">))</span>

        <span class="c1"># byhour</span>
        <span class="k">if</span> <span class="n">byhour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">HOURLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">dtstart</span><span class="o">.</span><span class="n">hour</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byhour</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byhour</span> <span class="o">=</span> <span class="p">(</span><span class="n">byhour</span><span class="p">,)</span>

            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">HOURLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__construct_byset</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dtstart</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                      <span class="n">byxxx</span><span class="o">=</span><span class="n">byhour</span><span class="p">,</span>
                                                      <span class="n">base</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">byhour</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byhour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span>

        <span class="c1"># byminute</span>
        <span class="k">if</span> <span class="n">byminute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">MINUTELY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">dtstart</span><span class="o">.</span><span class="n">minute</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byminute</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byminute</span> <span class="o">=</span> <span class="p">(</span><span class="n">byminute</span><span class="p">,)</span>

            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MINUTELY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__construct_byset</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dtstart</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                                                        <span class="n">byxxx</span><span class="o">=</span><span class="n">byminute</span><span class="p">,</span>
                                                        <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">byminute</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;byminute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span>

        <span class="c1"># bysecond</span>
        <span class="k">if</span> <span class="n">bysecond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">SECONDLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="p">((</span><span class="n">dtstart</span><span class="o">.</span><span class="n">second</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bysecond</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">bysecond</span> <span class="o">=</span> <span class="p">(</span><span class="n">bysecond</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bysecond</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">SECONDLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__construct_byset</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dtstart</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                                                        <span class="n">byxxx</span><span class="o">=</span><span class="n">bysecond</span><span class="p">,</span>
                                                        <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bysecond</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">&#39;bysecond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">&gt;=</span> <span class="n">HOURLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">minute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">second</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                                          <span class="n">tzinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output a string that would generate this RRULE if passed to rrulestr.</span>
<span class="sd">        This is mostly compatible with RFC2445, except for the</span>
<span class="sd">        dateutil-specific extension BYEASTER.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;DTSTART:%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">))</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FREQ=&#39;</span> <span class="o">+</span> <span class="n">FREQNAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;INTERVAL=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;WKST=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;COUNT=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;UNTIL=%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;byweekday&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The str() method on weekday objects doesn&#39;t generate</span>
            <span class="c1"># RFC2445-compliant strings, so we should modify that.</span>
            <span class="n">original_rule</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">)</span>
            <span class="n">wday_strings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">wday</span> <span class="ow">in</span> <span class="n">original_rule</span><span class="p">[</span><span class="s1">&#39;byweekday&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">wday</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                    <span class="n">wday_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{n:+d}{wday}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">wday</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">wday</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">wday</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wday_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">wday</span><span class="p">))</span>

            <span class="n">original_rule</span><span class="p">[</span><span class="s1">&#39;byweekday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wday_strings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span>

        <span class="n">partfmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">=</span><span class="si">{vals}</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;BYSETPOS&#39;</span><span class="p">,</span> <span class="s1">&#39;bysetpos&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYMONTH&#39;</span><span class="p">,</span> <span class="s1">&#39;bymonth&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYMONTHDAY&#39;</span><span class="p">,</span> <span class="s1">&#39;bymonthday&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYYEARDAY&#39;</span><span class="p">,</span> <span class="s1">&#39;byyearday&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYWEEKNO&#39;</span><span class="p">,</span> <span class="s1">&#39;byweekno&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYDAY&#39;</span><span class="p">,</span> <span class="s1">&#39;byweekday&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYHOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;byhour&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYMINUTE&#39;</span><span class="p">,</span> <span class="s1">&#39;byminute&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYSECOND&#39;</span><span class="p">,</span> <span class="s1">&#39;bysecond&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;BYEASTER&#39;</span><span class="p">,</span> <span class="s1">&#39;byeaster&#39;</span><span class="p">)]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">original_rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                                             <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))))</span>

        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">weekday</span><span class="p">,</span> <span class="n">yearday</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span>

        <span class="c1"># Some local variables to speed things up a bit</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span>
        <span class="n">wkst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span>
        <span class="n">until</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_until</span>
        <span class="n">bymonth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span>
        <span class="n">byweekno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span>
        <span class="n">byyearday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span>
        <span class="n">byweekday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span>
        <span class="n">byeaster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span>
        <span class="n">bymonthday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span>
        <span class="n">bynmonthday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span>
        <span class="n">bysetpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span>
        <span class="n">byhour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span>
        <span class="n">byminute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span>
        <span class="n">bysecond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span>

        <span class="n">ii</span> <span class="o">=</span> <span class="n">_iterinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>

        <span class="n">getdayset</span> <span class="o">=</span> <span class="p">{</span><span class="n">YEARLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ydayset</span><span class="p">,</span>
                     <span class="n">MONTHLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">mdayset</span><span class="p">,</span>
                     <span class="n">WEEKLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">wdayset</span><span class="p">,</span>
                     <span class="n">DAILY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">,</span>
                     <span class="n">HOURLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">,</span>
                     <span class="n">MINUTELY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">,</span>
                     <span class="n">SECONDLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">}[</span><span class="n">freq</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">HOURLY</span><span class="p">:</span>
            <span class="n">timeset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gettimeset</span> <span class="o">=</span> <span class="p">{</span><span class="n">HOURLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">htimeset</span><span class="p">,</span>
                          <span class="n">MINUTELY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">mtimeset</span><span class="p">,</span>
                          <span class="n">SECONDLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">stimeset</span><span class="p">}[</span><span class="n">freq</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">HOURLY</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="ow">and</span> <span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">MINUTELY</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="ow">and</span> <span class="n">minute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">SECONDLY</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="ow">and</span> <span class="n">second</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">)):</span>
                <span class="n">timeset</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Get dayset with the right frequency</span>
            <span class="n">dayset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">getdayset</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

            <span class="c1"># Do the &quot;hard&quot; work ;-)</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dayset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">bymonth</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">mmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bymonth</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byweekno</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byweekday</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byweekday</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">nwdaymask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">nwdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byeaster</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">eastermask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">bymonthday</span> <span class="ow">or</span> <span class="n">bynmonthday</span><span class="p">)</span> <span class="ow">and</span>
                     <span class="n">ii</span><span class="o">.</span><span class="n">mdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bymonthday</span> <span class="ow">and</span>
                     <span class="n">ii</span><span class="o">.</span><span class="n">nmdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bynmonthday</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byyearday</span> <span class="ow">and</span>
                     <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span> <span class="ow">and</span>
                       <span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span><span class="p">)</span> <span class="ow">or</span>
                      <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span> <span class="ow">and</span>
                       <span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">nextyearlen</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span><span class="p">)))):</span>
                    <span class="n">dayset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Output results</span>
            <span class="k">if</span> <span class="n">bysetpos</span> <span class="ow">and</span> <span class="n">timeset</span><span class="p">:</span>
                <span class="n">poslist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">bysetpos</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">daypos</span><span class="p">,</span> <span class="n">timepos</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeset</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">daypos</span><span class="p">,</span> <span class="n">timepos</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeset</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dayset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
                             <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">][</span><span class="n">daypos</span><span class="p">]</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">timeset</span><span class="p">[</span><span class="n">timepos</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">yearordinal</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">poslist</span><span class="p">:</span>
                            <span class="n">poslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">poslist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">poslist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="n">until</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                        <span class="k">return</span>
                    <span class="k">elif</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">:</span>
                        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">yield</span> <span class="n">res</span>
                        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dayset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">yearordinal</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">timeset</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="n">until</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                <span class="k">return</span>
                            <span class="k">elif</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">:</span>
                                <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">yield</span> <span class="n">res</span>
                                <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                                    <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                        <span class="k">return</span>

            <span class="c1"># Handle frequency and interval</span>
            <span class="n">fixday</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">YEARLY</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">+=</span> <span class="n">interval</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">MAXYEAR</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                    <span class="k">return</span>
                <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MONTHLY</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">+=</span> <span class="n">interval</span>
                <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">mod</span>
                    <span class="n">year</span> <span class="o">+=</span> <span class="n">div</span>
                    <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">month</span> <span class="o">=</span> <span class="mi">12</span>
                        <span class="n">year</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">MAXYEAR</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                        <span class="k">return</span>
                <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">WEEKLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wkst</span> <span class="o">&gt;</span> <span class="n">weekday</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">weekday</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="n">wkst</span><span class="p">))</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="o">*</span><span class="mi">7</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">weekday</span><span class="o">-</span><span class="n">wkst</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="o">*</span><span class="mi">7</span>
                <span class="n">weekday</span> <span class="o">=</span> <span class="n">wkst</span>
                <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">DAILY</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">+=</span> <span class="n">interval</span>
                <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">HOURLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                    <span class="c1"># Jump to one iteration before next day</span>
                    <span class="n">hour</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">23</span><span class="o">-</span><span class="n">hour</span><span class="p">)</span><span class="o">//</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">interval</span>

                <span class="k">if</span> <span class="n">byhour</span><span class="p">:</span>
                    <span class="n">ndays</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mod_distance</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span>
                                                      <span class="n">byxxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">,</span>
                                                      <span class="n">base</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ndays</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hour</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ndays</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">+=</span> <span class="n">ndays</span>
                    <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MINUTELY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                    <span class="c1"># Jump to one iteration before next day</span>
                    <span class="n">minute</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">1439</span><span class="o">-</span><span class="p">(</span><span class="n">hour</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">minute</span><span class="p">))</span><span class="o">//</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">interval</span>

                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">rep_rate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rep_rate</span> <span class="o">//</span> <span class="n">gcd</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">rep_rate</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">byminute</span><span class="p">:</span>
                        <span class="n">nhours</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">__mod_distance</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">minute</span><span class="p">,</span>
                                                <span class="n">byxxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">,</span>
                                                <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nhours</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minute</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

                    <span class="n">div</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hour</span><span class="o">+</span><span class="n">nhours</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">div</span><span class="p">:</span>
                        <span class="n">day</span> <span class="o">+=</span> <span class="n">div</span>
                        <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">byhour</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">byhour</span><span class="p">:</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid combination of interval and &#39;</span> <span class="o">+</span>
                                     <span class="s1">&#39;byhour resulting in empty rule.&#39;</span><span class="p">)</span>

                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">SECONDLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                    <span class="c1"># Jump to one iteration before next day</span>
                    <span class="n">second</span> <span class="o">+=</span> <span class="p">(((</span><span class="mi">86399</span> <span class="o">-</span> <span class="p">(</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">second</span><span class="p">))</span>
                                <span class="o">//</span> <span class="n">interval</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span><span class="p">)</span>

                <span class="n">rep_rate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rep_rate</span> <span class="o">//</span> <span class="n">gcd</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">rep_rate</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">bysecond</span><span class="p">:</span>
                        <span class="n">nminutes</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">__mod_distance</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">second</span><span class="p">,</span>
                                                <span class="n">byxxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">,</span>
                                                <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nminutes</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">second</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

                    <span class="n">div</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minute</span><span class="o">+</span><span class="n">nminutes</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">div</span><span class="p">:</span>
                        <span class="n">hour</span> <span class="o">+=</span> <span class="n">div</span>
                        <span class="n">div</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">div</span><span class="p">:</span>
                            <span class="n">day</span> <span class="o">+=</span> <span class="n">div</span>
                            <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">byhour</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">byhour</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="ow">not</span> <span class="n">byminute</span> <span class="ow">or</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">byminute</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="ow">not</span> <span class="n">bysecond</span> <span class="ow">or</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">bysecond</span><span class="p">)):</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid combination of interval, &#39;</span> <span class="o">+</span>
                                     <span class="s1">&#39;byhour and byminute resulting in empty&#39;</span> <span class="o">+</span>
                                     <span class="s1">&#39; rule.&#39;</span><span class="p">)</span>

                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fixday</span> <span class="ow">and</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">:</span>
                <span class="n">daysinmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="n">daysinmonth</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="n">daysinmonth</span><span class="p">:</span>
                        <span class="n">day</span> <span class="o">-=</span> <span class="n">daysinmonth</span>
                        <span class="n">month</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                            <span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">year</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">MAXYEAR</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                <span class="k">return</span>
                        <span class="n">daysinmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__construct_byset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">byxxx</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a `BYXXX` sequence is passed to the constructor at the same level as</span>
<span class="sd">        `FREQ` (e.g. `FREQ=HOURLY,BYHOUR={2,4,7},INTERVAL=3`), there are some</span>
<span class="sd">        specifications which cannot be reached given some starting conditions.</span>

<span class="sd">        This occurs whenever the interval is not coprime with the base of a</span>
<span class="sd">        given unit and the difference between the starting position and the</span>
<span class="sd">        ending position is not coprime with the greatest common denominator</span>
<span class="sd">        between the interval and the base. For example, with a FREQ of hourly</span>
<span class="sd">        starting at 17:00 and an interval of 4, the only valid values for</span>
<span class="sd">        BYHOUR would be {21, 1, 5, 9, 13, 17}, because 4 and 24 are not</span>
<span class="sd">        coprime.</span>

<span class="sd">        :param start:</span>
<span class="sd">            Specifies the starting position.</span>
<span class="sd">        :param byxxx:</span>
<span class="sd">            An iterable containing the list of allowed values.</span>
<span class="sd">        :param base:</span>
<span class="sd">            The largest allowable value for the specified frequency (e.g.</span>
<span class="sd">            24 hours, 60 minutes).</span>

<span class="sd">        This does not preserve the type of the iterable, returning a set, since</span>
<span class="sd">        the values should be unique and the order is irrelevant, this will</span>
<span class="sd">        speed up later lookups.</span>

<span class="sd">        In the event of an empty set, raises a :exception:`ValueError`, as this</span>
<span class="sd">        results in an empty rrule.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Support a single byxxx value.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byxxx</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="n">byxxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">byxxx</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">byxxx</span><span class="p">:</span>
            <span class="n">i_gcd</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="c1"># Use divmod rather than % because we need to wrap negative nums.</span>
            <span class="k">if</span> <span class="n">i_gcd</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">i_gcd</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid rrule byxxx generates an empty set.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cset</span>

    <span class="k">def</span> <span class="nf">__mod_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">byxxx</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the next value in a sequence where the `FREQ` parameter is</span>
<span class="sd">        specified along with a `BYXXX` parameter at the same &quot;level&quot;</span>
<span class="sd">        (e.g. `HOURLY` specified with `BYHOUR`).</span>

<span class="sd">        :param value:</span>
<span class="sd">            The old value of the component.</span>
<span class="sd">        :param byxxx:</span>
<span class="sd">            The `BYXXX` set, which should have been generated by</span>
<span class="sd">            `rrule._construct_byset`, or something else which checks that a</span>
<span class="sd">            valid rule is present.</span>
<span class="sd">        :param base:</span>
<span class="sd">            The largest allowable value for the specified frequency (e.g.</span>
<span class="sd">            24 hours, 60 minutes).</span>

<span class="sd">        If a valid value is not found after `base` iterations (the maximum</span>
<span class="sd">        number before the sequence would start to repeat), this raises a</span>
<span class="sd">        :exception:`ValueError`, as no valid values were found.</span>

<span class="sd">        This returns a tuple of `divmod(n*interval, base)`, where `n` is the</span>
<span class="sd">        smallest number of `interval` repetitions until the next specified</span>
<span class="sd">        value in `byxxx` is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">accumulator</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Using divmod() over % to account for negative intervals</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">div</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">byxxx</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">accumulator</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_iterinfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rrule&quot;</span><span class="p">,</span> <span class="s2">&quot;lastyear&quot;</span><span class="p">,</span> <span class="s2">&quot;lastmonth&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;yearlen&quot;</span><span class="p">,</span> <span class="s2">&quot;nextyearlen&quot;</span><span class="p">,</span> <span class="s2">&quot;yearordinal&quot;</span><span class="p">,</span> <span class="s2">&quot;yearweekday&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;mmask&quot;</span><span class="p">,</span> <span class="s2">&quot;mrange&quot;</span><span class="p">,</span> <span class="s2">&quot;mdaymask&quot;</span><span class="p">,</span> <span class="s2">&quot;nmdaymask&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;wdaymask&quot;</span><span class="p">,</span> <span class="s2">&quot;wnomask&quot;</span><span class="p">,</span> <span class="s2">&quot;nwdaymask&quot;</span><span class="p">,</span> <span class="s2">&quot;eastermask&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrule</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__slots__</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span> <span class="o">=</span> <span class="n">rrule</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
        <span class="c1"># Every mask is 7 days longer to handle cross-year weekly periods.</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastyear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">+</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextyearlen</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">+</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">firstyday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span> <span class="o">=</span> <span class="n">firstyday</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearweekday</span> <span class="o">=</span> <span class="n">firstyday</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

            <span class="n">wday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span> <span class="o">==</span> <span class="mi">365</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mmask</span> <span class="o">=</span> <span class="n">M365MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mdaymask</span> <span class="o">=</span> <span class="n">MDAY365MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmdaymask</span> <span class="o">=</span> <span class="n">NMDAY365MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span> <span class="o">=</span> <span class="n">WDAYMASK</span><span class="p">[</span><span class="n">wday</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mrange</span> <span class="o">=</span> <span class="n">M365RANGE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mmask</span> <span class="o">=</span> <span class="n">M366MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mdaymask</span> <span class="o">=</span> <span class="n">MDAY366MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmdaymask</span> <span class="o">=</span> <span class="n">NMDAY366MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span> <span class="o">=</span> <span class="n">WDAYMASK</span><span class="p">[</span><span class="n">wday</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mrange</span> <span class="o">=</span> <span class="n">M366RANGE</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
                <span class="c1"># no1wkst = firstwkst = self.wdaymask.index(rr._wkst)</span>
                <span class="n">no1wkst</span> <span class="o">=</span> <span class="n">firstwkst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yearweekday</span><span class="o">+</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                <span class="k">if</span> <span class="n">no1wkst</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">no1wkst</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># Number of days in the year, plus the days we got</span>
                    <span class="c1"># from last year.</span>
                    <span class="n">wyearlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearweekday</span><span class="o">-</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Number of days in the year, minus the days we</span>
                    <span class="c1"># left in last year.</span>
                    <span class="n">wyearlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">-</span><span class="n">no1wkst</span>
                <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">wyearlen</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">numweeks</span> <span class="o">=</span> <span class="n">div</span><span class="o">+</span><span class="n">mod</span><span class="o">//</span><span class="mi">4</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="n">numweeks</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">numweeks</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">no1wkst</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
                        <span class="k">if</span> <span class="n">no1wkst</span> <span class="o">!=</span> <span class="n">firstwkst</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">-=</span> <span class="mi">7</span><span class="o">-</span><span class="n">firstwkst</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">no1wkst</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                    <span class="c1"># Check week number 1 of next year as well</span>
                    <span class="c1"># TODO: Check -numweeks for next year.</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">no1wkst</span><span class="o">+</span><span class="n">numweeks</span><span class="o">*</span><span class="mi">7</span>
                    <span class="k">if</span> <span class="n">no1wkst</span> <span class="o">!=</span> <span class="n">firstwkst</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">7</span><span class="o">-</span><span class="n">firstwkst</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="p">:</span>
                        <span class="c1"># If week starts in next year, we</span>
                        <span class="c1"># don&#39;t care about it.</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="n">no1wkst</span><span class="p">:</span>
                    <span class="c1"># Check last week number of last year as</span>
                    <span class="c1"># well. If no1wkst is 0, either the year</span>
                    <span class="c1"># started on week start, or week number 1</span>
                    <span class="c1"># got days from last year, so there are no</span>
                    <span class="c1"># days from last year&#39;s last week number in</span>
                    <span class="c1"># this year.</span>
                    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                        <span class="n">lyearweekday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
                        <span class="n">lno1wkst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="n">lyearweekday</span><span class="o">+</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                        <span class="n">lyearlen</span> <span class="o">=</span> <span class="mi">365</span><span class="o">+</span><span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lno1wkst</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">lno1wkst</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">lnumweeks</span> <span class="o">=</span> <span class="mi">52</span><span class="o">+</span><span class="p">(</span><span class="n">lyearlen</span> <span class="o">+</span>
                                            <span class="p">(</span><span class="n">lyearweekday</span><span class="o">-</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="o">//</span><span class="mi">4</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lnumweeks</span> <span class="o">=</span> <span class="mi">52</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">-</span><span class="n">no1wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="o">//</span><span class="mi">4</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lnumweeks</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">lnumweeks</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no1wkst</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="ow">and</span> <span class="p">(</span><span class="n">month</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastmonth</span> <span class="ow">or</span>
                                <span class="n">year</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastyear</span><span class="p">)):</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">rr</span><span class="o">.</span><span class="n">_freq</span> <span class="o">==</span> <span class="n">YEARLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bymonth</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bymonth</span><span class="p">:</span>
                        <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mrange</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">rr</span><span class="o">.</span><span class="n">_freq</span> <span class="o">==</span> <span class="n">MONTHLY</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mrange</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">ranges</span><span class="p">:</span>
                <span class="c1"># Weekly frequency won&#39;t get here, so we may not</span>
                <span class="c1"># care about cross-year weekly periods.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nwdaymask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>
                <span class="k">for</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">wday</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">last</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
                            <span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">wday</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">wday</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                        <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">nwdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byeaster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eastermask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">eyday</span> <span class="o">=</span> <span class="n">easter</span><span class="o">.</span><span class="n">easter</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span>
            <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byeaster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eastermask</span><span class="p">[</span><span class="n">eyday</span><span class="o">+</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastyear</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastmonth</span> <span class="o">=</span> <span class="n">month</span>

    <span class="k">def</span> <span class="nf">ydayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>

    <span class="k">def</span> <span class="nf">mdayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mrange</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">dset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">wdayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="c1"># We need to handle cross-year weeks here.</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># if (not (0 &lt;= i &lt; self.yearlen) or</span>
            <span class="c1">#    self.wdaymask[i] == self.rrule._wkst):</span>
            <span class="c1"># This will cross the year boundary, if necessary.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">dset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">ddayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span>
        <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">dset</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">htimeset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="n">tset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span>
        <span class="k">for</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byminute</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">:</span>
                <span class="n">tset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                                          <span class="n">tzinfo</span><span class="o">=</span><span class="n">rr</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">))</span>
        <span class="n">tset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tset</span>

    <span class="k">def</span> <span class="nf">mtimeset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="n">tset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span>
        <span class="k">for</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">:</span>
            <span class="n">tset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">rr</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">))</span>
        <span class="n">tset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tset</span>

    <span class="k">def</span> <span class="nf">stimeset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                <span class="n">tzinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">),)</span>


<span class="k">class</span> <span class="nc">rruleset</span><span class="p">(</span><span class="n">rrulebase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The rruleset type allows more complex recurrence setups, mixing</span>
<span class="sd">    multiple rules, dates, exclusion rules, and exclusion dates. The type</span>
<span class="sd">    constructor takes the following keyword arguments:</span>

<span class="sd">    :param cache: If True, caching of results will be enabled, improving</span>
<span class="sd">                  performance of multiple queries considerably. &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">_genitem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genlist</span><span class="p">,</span> <span class="n">gen</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
                <span class="n">genlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genlist</span> <span class="o">=</span> <span class="n">genlist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span>

        <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="p">)</span>

        <span class="nb">next</span> <span class="o">=</span> <span class="n">__next__</span>

        <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">rruleset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrule</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exrule</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">rrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Include the given :py:class:`rrule` instance in the recurrence set</span>
<span class="sd">            generation. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rrule</span><span class="p">)</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">rdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Include the given :py:class:`datetime` instance in the recurrence</span>
<span class="sd">            set generation. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdate</span><span class="p">)</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">exrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exrule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Include the given rrule instance in the recurrence set exclusion</span>
<span class="sd">            list. Dates which are part of the given recurrence rules will not</span>
<span class="sd">            be generated, even if some inclusive rrule or rdate matches them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exrule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exrule</span><span class="p">)</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">exdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exdate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Include the given datetime instance in the recurrence set</span>
<span class="sd">            exclusion list. Dates included that way will not be generated,</span>
<span class="sd">            even if some inclusive rrule or rdate matches them. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exdate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrule</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">exlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">exlist</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exrule</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">exlist</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">lastdt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">rlist</span><span class="p">)</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">exlist</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rlist</span><span class="p">:</span>
            <span class="n">ritem</span> <span class="o">=</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lastdt</span> <span class="ow">or</span> <span class="n">lastdt</span> <span class="o">!=</span> <span class="n">ritem</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">exlist</span> <span class="ow">and</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ritem</span><span class="p">:</span>
                    <span class="n">exitem</span> <span class="o">=</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">advance_iterator</span><span class="p">(</span><span class="n">exitem</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exlist</span> <span class="ow">and</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">exitem</span><span class="p">:</span>
                        <span class="n">heapq</span><span class="o">.</span><span class="n">heapreplace</span><span class="p">(</span><span class="n">exlist</span><span class="p">,</span> <span class="n">exitem</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exlist</span> <span class="ow">or</span> <span class="n">ritem</span> <span class="o">!=</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">ritem</span><span class="o">.</span><span class="n">dt</span>
                <span class="n">lastdt</span> <span class="o">=</span> <span class="n">ritem</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">advance_iterator</span><span class="p">(</span><span class="n">ritem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rlist</span> <span class="ow">and</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ritem</span><span class="p">:</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heapreplace</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="n">ritem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>


<span class="k">class</span> <span class="nc">_rrulestr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">_freq_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;YEARLY&quot;</span><span class="p">:</span> <span class="n">YEARLY</span><span class="p">,</span>
                 <span class="s2">&quot;MONTHLY&quot;</span><span class="p">:</span> <span class="n">MONTHLY</span><span class="p">,</span>
                 <span class="s2">&quot;WEEKLY&quot;</span><span class="p">:</span> <span class="n">WEEKLY</span><span class="p">,</span>
                 <span class="s2">&quot;DAILY&quot;</span><span class="p">:</span> <span class="n">DAILY</span><span class="p">,</span>
                 <span class="s2">&quot;HOURLY&quot;</span><span class="p">:</span> <span class="n">HOURLY</span><span class="p">,</span>
                 <span class="s2">&quot;MINUTELY&quot;</span><span class="p">:</span> <span class="n">MINUTELY</span><span class="p">,</span>
                 <span class="s2">&quot;SECONDLY&quot;</span><span class="p">:</span> <span class="n">SECONDLY</span><span class="p">}</span>

    <span class="n">_weekday_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MO&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;TU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;WE&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;TH&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s2">&quot;FR&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;SA&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;SU&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_handle_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_int_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

    <span class="n">_handle_INTERVAL</span> <span class="o">=</span> <span class="n">_handle_int</span>
    <span class="n">_handle_COUNT</span> <span class="o">=</span> <span class="n">_handle_int</span>
    <span class="n">_handle_BYSETPOS</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYMONTH</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYMONTHDAY</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYYEARDAY</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYEASTER</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYWEEKNO</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYHOUR</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYMINUTE</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYSECOND</span> <span class="o">=</span> <span class="n">_handle_int_list</span>

    <span class="k">def</span> <span class="nf">_handle_FREQ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_handle_UNTIL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">parser</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">&quot;until&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
                                             <span class="n">ignoretz</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignoretz&quot;</span><span class="p">),</span>
                                             <span class="n">tzinfos</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tzinfos&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid until date&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_WKST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">&quot;wkst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weekday_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_handle_BYWEEKDAY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Two ways to specify this: +1MO or MO(+1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wday</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">wday</span><span class="p">:</span>
                <span class="c1"># If it&#39;s of the form TH(+1), etc.</span>
                <span class="n">splt</span> <span class="o">=</span> <span class="n">wday</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">wday</span><span class="p">):</span>
                <span class="c1"># If it&#39;s of the form +1MO</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wday</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">wday</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;+-0123456789&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">wday</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">wday</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid (empty) BYDAY specification.&quot;</span><span class="p">)</span>

            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weekdays</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekday_map</span><span class="p">[</span><span class="n">w</span><span class="p">]](</span><span class="n">n</span><span class="p">))</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">&quot;byweekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

    <span class="n">_handle_BYDAY</span> <span class="o">=</span> <span class="n">_handle_BYWEEKDAY</span>

    <span class="k">def</span> <span class="nf">_parse_rfc_rrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
                         <span class="n">dtstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">ignoretz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">tzinfos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;RRULE&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown parameter name&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">rrkwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_handle_&quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)(</span><span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                               <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                               <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown parameter &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rrule</span><span class="p">(</span><span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="o">**</span><span class="n">rrkwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_rfc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
                   <span class="n">dtstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">unfold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">forceset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">ignoretz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">tzinfos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">parser</span>
        <span class="k">if</span> <span class="n">compatible</span><span class="p">:</span>
            <span class="n">forceset</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">unfold</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unfold</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                    <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">forceset</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                                                  <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;RRULE:&#39;</span><span class="p">))):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                         <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span> <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                         <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rrulevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rdatevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">exrulevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">exdatevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;RRULE&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parms</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty property name&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;RRULE&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported RRULE parm: &quot;</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">rrulevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;RDATE&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parm</span> <span class="o">!=</span> <span class="s2">&quot;VALUE=DATE-TIME&quot;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported RDATE parm: &quot;</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">rdatevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;EXRULE&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported EXRULE parm: &quot;</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">exrulevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;EXDATE&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parm</span> <span class="o">!=</span> <span class="s2">&quot;VALUE=DATE-TIME&quot;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported RDATE parm: &quot;</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">exdatevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;DTSTART&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported DTSTART parm: &quot;</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
                    <span class="n">dtstart</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                           <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported property: &quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">forceset</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rrulevals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">rdatevals</span>
                    <span class="ow">or</span> <span class="n">exrulevals</span> <span class="ow">or</span> <span class="n">exdatevals</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rdatevals</span> <span class="ow">or</span> <span class="n">exdatevals</span><span class="p">):</span>
                    <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
                <span class="n">rset</span> <span class="o">=</span> <span class="n">rruleset</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rrulevals</span><span class="p">:</span>
                    <span class="n">rset</span><span class="o">.</span><span class="n">rrule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>
                                                     <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                     <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rdatevals</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                        <span class="n">rset</span><span class="o">.</span><span class="n">rdate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span>
                                                <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">exrulevals</span><span class="p">:</span>
                    <span class="n">rset</span><span class="o">.</span><span class="n">exrule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>
                                                      <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                      <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">exdatevals</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                        <span class="n">rset</span><span class="o">.</span><span class="n">exdate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span>
                                                 <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                 <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">compatible</span> <span class="ow">and</span> <span class="n">dtstart</span><span class="p">:</span>
                    <span class="n">rset</span><span class="o">.</span><span class="n">rdate</span><span class="p">(</span><span class="n">dtstart</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">rrulevals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>
                                             <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                             <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                             <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">rrulestr</span> <span class="o">=</span> <span class="n">_rrulestr</span><span class="p">()</span>

<span class="c1"># vim:ts=4:sw=4:et</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>